# Decompiled Subs

This directory contains various decompiled subs that are involved
in the Unknown6 computation.

## General Structure

The main entry point, probably called from the client app code,
is **sub_564C8**.  It receives an object *(precise format unknown)*
containing various information
(like sensor and location data) as a parameter.  Its main task is
probably to compose the on-wire message, but for us the two interesting
parts of this subroutine are:

  * Creation of the input buffer (which is a serialization of
    **Signature.proto** protobuf? i.e. the Unknown6)

  * Encryption of the input buffer (**already reverse
    engineered and available as libencrypt**).

| Sub Name      | Details |
|---------------|---------|
| sub_564C8     | Main function, no XREFs, only in a VFTable |
| sub_56B28     | calls sub_564C8 (nothing else)  
|---------------|---------|

### Input Buffer Creation

Various variables reference pieces of the parameter object in 564C8,
most prominently v26.

Some kind of first pass of Signature computation happens in sub_3FE3C(),
which stores the final serialized length to v32 (of 564C8).  The actual
serialization happens in sub_41618() which stores the serialized buffer
to *v35.  (Note the *, aka v35[0] - the other array fields are something
else!)

| Sub Name      | Details |
|---------------|---------|
| sub_3FE3C     | calculate size for encoded Signature proto and write size of request_hash |
| sub_11525C    | Called in sub_3FE3C    |
| sub_115284    | calculate size needed to encode int64 as varint |
| sub_3EAAC     | Called in sub_3FE3C    |
| sub_3E8B0     | Called in sub_3FE3C    |
| sub_3F480     | Called in sub_3FE3C    |
| sub_3F7E4     | Called in sub_3FE3C    |
| sub_3F584     | Called in sub_3FE3C    |
| sub_3F694     | Called in sub_3FE3C    |
|---------------|---------|
| sub_41618     | Generate Signature proto        |
| sub_401D8     | Generate LocationFix proto |
| sub_413C4     | Generate unknown5 proto |
| sub_403E0     | Called in sub_41615, may be protobuf autogenerated code or part of the library            |
| sub_40870     | Called in sub_41616, may be protobuf autogenerated code or part of the library            |
| sub_40640     | Called in sub_41617, may be protobuf autogenerated code or part of the library            |
| sub_4059C     | Called in sub_41618, may be protobuf autogenerated code or part of the library            |

Some of the routines may be parts of the protobuf library.

| Sub Name      | Details |
|---------------|---------|
| sub_1152FC    | write bytes field to proto buffer |
| sub_114D9C    | Write int64 as varint to proto buffer |

These subs aren't included in git but have specific meaning:
  * sub_54D28 = generate xxHash32
  * sub_546C8 = generate xxHash64


### Encryption

See ../c_code/encrypt.c for an already working amalgamation of these.

| Sub Name      | Details |
|---------------|---------|
| sub_87444     | Called from 564C8       |
| sub_9E9D8     | Called from 87444, has a main loop that calls functions from table at off_1F7060        |
| sub_87568+1   | Function table called from 9E9D8        |
| sub_8930C+1   | Function table called from 9E9D8. requires a string/blob of 744 bytes and then decrypt|encrypts it (original content destroyed)        |
| sub_8B2F4+1   | Function table called from 9E9D8        |
| sub_8D114+1   | Function table called from 9E9D8        |
| sub_8F0B0+1   | Function table called from 9E9D8        |
| sub_910A8+1   | Function table called from 9E9D8        |
| sub_92E08+1   | Function table called from 9E9D8        |
| sub_94BDC+1   | Function table called from 9E9D8        |
| sub_96984+1   | Function table called from 9E9D8        |
| sub_985E0+1   | Function table called from 9E9D8        |
| sub_9A490+1   | Function table called from 9E9D8        |
| sub_9E1C4+1   | Function table called from 9E9D8        |
| sub_9C42C+1   | Function table called from 9E9D8        |

### Other Subs

No clue why do we have these. :)

| Sub Name      | Details |
|---------------|---------|
| sub_43B8C     |         
| sub_43B78     | Called in sub_43B8C     
| sub_43B30     | Called in sub_43B8C     
| sub_1B7E44    | Called in sub_43B8C     
|---------------|---------|
| sub_1B86EC    | Calls sub_19B6C4 with inline sum        |
| sub_19B6C4    | Called in sub_1B86EC    
|---------------|---------|
| sub_8742C     |         |

### Standard Library

Some subs are pieces of a standard library.  A good rule of thumb
may be that six-digit subs are parts of library?

Here are some subs that are probably parts of some library
but need identifying:

| Sub Name      | Details |
|---------------|---------|
| sub_11BB2C    | printf wrapper |
| sub_11BBB4    | printf wrapper |
| sub_1B7044    | some exception |
| sub_1B6F2C    | exception helper (unwinds stack?) |
| sub_19B6C4    | basic_string::_S_construct |
| sub_1B8850    | sub_19B6C4 wrapper |
| sub_1B6FC0    | some exception |
| sub_1B85C0    | |
| sub_1ABEE0    | |
| sub_1B8200    | |


Already identified functions are kept in this
translation table in case they pop up in newly decompiled code:

| Sub Name      | Real Name |
|---------------|-----------|
| sub_110830    | WireFormat::VerifyUTF8StringFallback |
| sub_11AC24    | ProtoBuf::LogMessage::constructor |
| sub_11ABD0    | ``ProtoBuf::LogMessage::operator<<`` |
| sub_11B094    | ProtoBuf::LogMessage::equalsOperator |
| sub_11AC40    | ProtoBuf::LogMessage::destructor |
| sub_19B6C4    | std::basic_string |
| sub_1B6FC0    | std::logic_error |
| sub_1B7D04    | basic_string::_S_create |
| sub_1B83E4    | basic_string::append |

## Various Notes

  * ``_DWORD`` is 32bit (``uint32_t``); ``_QWORD`` is 64bit (``uint64_t``).

  * Type inference of the compiler may not be accurate.  For example,
    an (int) variable may as well in fact contain a pointer.
